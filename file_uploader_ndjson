# -*- coding: utf-8 -*-

import streamlit as st
from PIL import Image
import boto3
import os
import time
import ndjson
import csv

st.set_page_config(
    page_title = 'Photo Upload',
    page_icon = 'ğŸ“·',
)


#################################################################################
# edit internal files


# # os.makedirs("/home/appuser/.aws/", exist_ok=True)
# ls = os.listdir("/home/appuser/.aws/")
# # currentdir = os.getcwd("/")
 
# # st.write(currentdir)
# st.write(ls)

# f = open('/home/appuser/.aws/credentials', 'w')
# test = st.secrets["AWS_ACCESS_KEY_ID"]
# test2 = st.secrets["AWS_SECRET_ACCESS_KEY"]
# f.write(f'[default]\naws_access_key_id = {test}\naws_secret_access_key = {test2}')
# f.close()

# st.write(test)
# st.write(test2)

# f = open('/home/appuser/.aws/credentials', 'r')
# st.write(f.read())
# f.close()

# f = open('/home/appuser/.aws/config', 'w')
# f.write("[default]\nregion = ap-northeast-1")
# f.close()

# ls = os.listdir("/home/appuser/.aws/")
# st.write(ls)

#################################################################################



#pre_password = st.secrets["PRE_PASSWORD"]
#input_password = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", help="äº‹å‰ã«äº‹å‹™å±€ã‚ˆã‚Šé€šçŸ¥ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’åŠè§’è‹±æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„", value="", type="password")

#if str(pre_password) != str(input_password):
#    st.warning('å†™çœŸã‚’æŠ•ç¨¿ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
#    st.stop()

# formæ©Ÿèƒ½ã‚’ä½¿ã‚ãªã„å ´åˆé¢¨èˆ¹ãªã©ã¯ä½¿ã‚ãªã„
# tempo = st.success('èªè¨¼æˆåŠŸ')
# time.sleep(1)
# tempo.balloons()

#s3 = boto3.client('s3',
#        aws_access_key_id= st.secrets["AWS_ACCESS_KEY_ID"],
#        aws_secret_access_key= st.secrets["AWS_SECRET_ACCESS_KEY"] ,
#        region_name='ap-northeast-1'
#)

st.write(
    """
    # æŠ€é–‹ãƒ»PFC ãƒ•ã‚©ãƒˆã‚³ãƒ³ãƒ†ã‚¹ãƒˆ ï¼’ï¼ï¼’ï¼‘
    ## å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ 
    ### å†™çœŸã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
    """
)

# LDP = tuple(st.secrets["LDP"])
# SDP_a = tuple(st.secrets["SDP_a"])
# SDP_b = tuple(st.secrets["SDP_b"])
# SDP_c = tuple(st.secrets["SDP_c"])
# SDP_d = tuple(st.secrets["SDP_d"])

LDP = ["aaa","bbb", "ccc", "other"]
SDP_a = ["a_1234","a_567", "a_89"]
SDP_b = ["b_1234","b_567", "b_89"]
SDP_c = ["c_1234","c_567", "c_89"]
SDP_d = ["test_company","write direct"]


# LDP = tuple(LDP)
# SDP_a = tuple(SDP_a)
# SDP_b = tuple(SDP_b)
# SDP_c = tuple(SDP_c)
# SDP_d = tuple(SDP_d)

department_L = st.selectbox("æ‰€å±ï¼ˆå¤§åˆ†é¡ï¼‰", LDP)
if department_L == LDP[0]:
    department_S = st.selectbox("æ‰€å±ï¼ˆå°åˆ†é¡ï¼‰",SDP_a)
elif department_L == LDP[1]:
    department_S = st.selectbox("æ‰€å±ï¼ˆå°åˆ†é¡ï¼‰",SDP_b)
elif department_L == LDP[2]:
    department_S = st.selectbox("æ‰€å±ï¼ˆå°åˆ†é¡ï¼‰",SDP_c)
else:
    department_S = st.selectbox("æ‰€å±ï¼ˆå°åˆ†é¡ï¼‰",SDP_d)
    if department_S == SDP_d[1]:
        department_S = st.text_input("ç›´æ¥è¨˜å…¥")
family_name = st.text_input(label="æ°åï¼ˆè‹—å­—ã®ã¿ï¼‰  ä¾‹ï¼šç”°ä¸­ã€€å¤ªéƒ â†’ ã€Œç”°ä¸­ã€")    
nick_name = st.text_input(label='ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆä»»æ„ï¼‰ â€»å†™çœŸå…¬é–‹æ™‚ã«æ°åã‚’å…¬é–‹ã—ãŸããªã„æ–¹ã¯å…¥åŠ›ã—ã¦ä¸‹ã•ã„ã€‚')
img_type = st.selectbox("æå‡ºå…ˆã®éƒ¨é–€",("é¢¨æ™¯","ç”Ÿãç‰©","AIãŒé–“é•ãˆã‚‹ã‹","ã‚¹ãƒ†ã‚¤ãƒ›ãƒ¼ãƒ ","è²·ã£ã¦ã‚ˆã‹ã£ãŸã‚‚ã®","æ˜ ãˆ"))
uploaded_file =  st.file_uploader("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚ï¼ˆpngã€jpegã€jpgå½¢å¼ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚ï¼‰", type=['png','jpeg','jpg'])
if uploaded_file is not None:
    #file_details = {"FileName":uploaded_file.name,"FileType":uploaded_file.type,"FileSize":uploaded_file.size}
    #st.write(file_details)
    # st.write(uploaded_file)
    try:
        img = Image.open(uploaded_file)
        name = uploaded_file.name
        st.image(img, caption=name)
    except:
        st.error("ã“ã®ç”»åƒã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã¾ã›ã‚“")


img_title = st.text_input('å†™çœŸã®ã‚¿ã‚¤ãƒˆãƒ«')
comment = st.text_area('å†™çœŸã«å¯¾ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆ')

submit_button2 = st.button(label='æå‡º')




if submit_button2 == True:
    try:
        os.makedirs("./uploaded/", exist_ok=True)
        rnd_number = str(time.time())[-6:]
        img.save("./uploaded/"+ rnd_number + "_" + name )
        s3 = boto3.resource('s3') #S3ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
        bucket = s3.Bucket('photocon2')
        bucket.upload_file("./uploaded/"+ rnd_number + "_" + name, rnd_number + "_" + name)
        os.remove("./uploaded/"+ rnd_number + "_" + name)
        st.success(
            f'å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ\n ãƒ•ã‚¡ã‚¤ãƒ«å:{name}\n\néƒ¨é–€ï¼š{department_L}\n\néƒ¨é–€ï¼š{img_type}\n\néƒ¨é–€ï¼š{img_title}\n\nã‚³ãƒ¡ãƒ³ãƒˆå:{comment}'
            )

        
        #æŠ•ç¨¿ã•ã‚ŒãŸæƒ…å ±ã‚’dictå½¢å¼ã«ã™ã‚‹
        save_data_dict = {'sales_id': sales_id, 'department_L':department_L,'department_S':department_S,'family_name':family_name,'nick_name':nick_name,'img_type':img_type,'img_title':img_title, 'comment': comment, 'pass':"./uploaded/"+ rnd_number + "_" + name}

        filename = './uploaded/'+ rnd_number + '_' + name + '.ndjson'


        with open(filename, 'a') as f:
            writer = ndjson.writer(f,ensure_ascii=False)
            writer.writerow(save_data_dict)


        with open(filename) as f:
            data = ndjson.load(f)
        st.write(data)


    except:
        st.error("ã‚¨ãƒ©ãƒ¼")


